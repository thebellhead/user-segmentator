# avito-prod

Production Golang task for AvitoTech backend internship.

## Basic usage

Full containerization off the app and the database was impossible due to problems in host resolving.

To run the API, one should:
1. `docker compose up -d` from the root directory of the project to run the database container;
2. `go run main.go` or use [AIR](https://github.com/cosmtrek/air) to run the application;
3. use `localhost:8000` for HTTP-requests.

## Database specification

### Entities

This repository contains a REST API for user segmentation. There are two database entities:
- **Users** - users of Avito platform that partake in the experiments. They are represented by **integer IDs**, as specified in the task, and **UUIDs** for long-term application, as UUIDs are better suited for primary keys.
- **Segments** - special tags that represent that a user is taking part in a certain experiment (30% discount, voice messaging, etc.). Each user can contain multiple segments and each segment can contain multiple users.

### Tables

The database contains 3 tables:
- **User** table:
  - UserID (integer)
  - UserUUID (UUID)
- **Segment** table:
  - SegmentSlug (varchar)
  - SegmentID (UUID)
- **UserSegment** table:
  - UserUUID (UUID)
  - SegmentID (UUID)

## Technical details

The API's stack is:
- Gin (web server);
- GORM (object-relational mapper);
- PostgreSQL (database);
- Docker (containerization).

After `docker compose up` the API is available at http://localhost:8000.

Exact schemas used in GORM for representing data relations are specified in the `swagger.yml` file.

## API usage

### Methods

The REST API has 4 main methods (as specified in the task):
- `api/segment/create` creates a new segment with the given slug and an autogenerated UUID.
- `api/segment/delete` deletes the segment with a given slug. If any users contain the deleted segment, they are updated to no longer contain it.
- `api/user/create` creates a user with the given ID or updates the user if the ID exists in the database. Then the method adds segments by the given slugs to this user. Finally, the method deletes segments from the user by the given slugs.
- `api/user/get` retrieves an array of all segments in which the user with a given ID partakes.

Some additional helper methods:
- `api/segment/check` retrieves an array of all segments with their slugs and IDs.
- `api/user/check` retrieves an array of all users with their integer IDs and UUIDs.
- `api/user/records` retrieves all user-segment relations (both represented by UUIDs).

### Usage examples

#### POST CreateSegment `api/segment/create`

Request type: `POST`

Request JSON:
```json
{
  "segmentSlug": "avito5"
}
```

Response JSON if segment with this slug does not already exist (**code 201**):
```json
{
  "data": {
    "segment": {
      "SegmentID": "eea6e857-7d3d-4911-bda9-507a8591c5be",
      "SegmentSlug": "avito5"
    }
  },
  "status": "success"
}
```

Response JSON if segment with this slug already exists (**code 409**):
```json
{
  "message": "Segment with that slug already exists",
  "status": "fail"
}
```

#### POST CreateSegment `api/segment/create` с автозаполнением пользователями

Request type: `POST`

Request JSON:
```json
{
  "segmentSlug": "avitoA1",
  "autoAdd": true,
  "userPercentage": 50.0
}
```

Response JSON if segment with this slug does not already exist (**code 201**):
```json
{
  "data": {
    "segment": {
      "SegmentID": "004607c4-1730-4021-b2b0-73a001c3277c",
      "SegmentSlug": "avitoA1"
    }
  },
  "status": "success"
}
```

Response JSON if segment with this slug already exists (**code 409**):
```json
{
  "message": "Segment with that slug already exists",
  "status": "fail"
}
```

#### DELETE DeleteSegment `api/segment/delete`

Request type: `DELETE`

Request JSON:
```json
{
  "segmentSlug": "avito5"
}
```

Response JSON if segment with this slug already exists (**code 200**):
```json
{
  "data": {
    "slug": "avito5"
  },
  "status": "success"
}
```

Response JSON if segment with this slug does not already exist (**code 400**):
```json
{
  "message": "No segment with this slug",
  "status": "fail"
}
```

#### POST CreateUser `api/user/create`

Request type: `POST`

Request JSON:
```json
{
  "userID": 420,
  "segmentsAdd": [
    "avito3",
    "avito3",
    "avito3",
    "avito3",
    "avito4",
    "avito1"
  ],
  "segmentsDelete": [
    "avito1"
  ]
}
```

Response JSON if user with this ID does not already exist (**code 201**):
```json
{
  "data": {
    "user": {
      "userID": 420,
      "segments": [
        "avito3",
        "avito4"
      ]
    }
  },
  "status": "success"
}
```

Response JSON if user with this ID already exists (**code 200**):
```json
{
  "data": {
    "user": {
      "userID": 420,
      "segments": [
        "avito3",
        "avito4"
      ]
    }
  },
  "status": "success"
}
```

Notes:
- non-existing segment slugs will be ignored;
- repeating slugs will be ignored;
- first, the segments are added, then they are deleted (if `"avito1"` is added and deleted, it does not appear in the database).

#### GET GetUserByID `api/user/get`

Request type: `GET`

Request JSON:
```json
{
  "userID": 420
}
```

Response JSON if user with this ID already exists (**code 200**):
```json
{
  "data": {
    "user": {
      "userID": 420,
      "segments": [
        "avito3",
        "avito4"
      ]
    }
  },
  "status": "success"
}
```

Response JSON if user with this ID does not already exist (**code 400**):
```json
{
  "message": "User with this ID not found",
  "status": "error"
}
```

#### GET GetSegments `api/segment/check`

Request type: `GET`

No request JSON!

Response JSON (**code 200**):
```json
{
  "data": {
    "segments": [
      {
        "SegmentID": "ac90b8ab-8ec2-41b6-9771-87d5e0fcff50",
        "SegmentSlug": "avito7"
      },
      {
        "SegmentID": "f3fa0343-6b35-48d9-b38e-b4956ff6b39f",
        "SegmentSlug": "avito1"
      },
      {
        "SegmentID": "7d6557ea-ddfc-4bd4-bf77-a3a8a57b68df",
        "SegmentSlug": "avito3"
      },
      {
        "SegmentID": "6495b88d-f923-4fe6-aab8-b1b3d5b67f76",
        "SegmentSlug": "avito4"
      }
    ]
  },
  "status": "success"
}
```

#### GET GetUsers `api/user/check`

Request type: `GET`

No request JSON!

Response JSON (**code 200**):
```json
{
  "data": {
    "users": [
      {
        "UserUUID": "3aed3978-175d-41f9-be78-538dee6705b6",
        "UserID": 15
      },
      {
        "UserUUID": "48810e62-1071-444e-8e7b-3f242e4fe09e",
        "UserID": 420
      }
    ]
  },
  "status": "success"
}
```

#### GET GetRecords `api/user/records`

Request type: `GET`

No request JSON!

Response JSON (**code 200**):
```json
{
  "data": {
    "records": [
      {
        "UserUUID": "48810e62-1071-444e-8e7b-3f242e4fe09e",
        "SegmentID": "7d6557ea-ddfc-4bd4-bf77-a3a8a57b68df"
      },
      {
        "UserUUID": "48810e62-1071-444e-8e7b-3f242e4fe09e",
        "SegmentID": "6495b88d-f923-4fe6-aab8-b1b3d5b67f76"
      }
    ]
  },
  "status": "success"
}
```